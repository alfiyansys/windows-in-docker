#!/usr/bin/env python3

from argparse import ArgumentParser, Namespace
from multiprocessing import cpu_count
from os import popen
from subprocess import run
from typing import Tuple
from uuid import uuid4


_vmdk_dir_ = "/config"
_sound_ = "hda"


def console_size() -> Tuple[int, int]:
  try:
    with popen("stty size", "r") as fd:
      rows, cols = [int(chars) for chars in fd.read().split()]
      return rows, cols
  except:
    return -1, -1


def pprn(msg, err=False, before="", after="", centre=False) -> None:
  _, cols = console_size()
  ml = len(msg)
  cols = 20 if cols == -1 else cols
  padding = 0 if not centre or ml > cols else int((cols - ml) / 2)
  msg = f"{before * cols}\n{' ' * padding}{msg}\n{after * cols}"
  print(msg)


def parse() -> Namespace:
  parser = ArgumentParser()

  parser.add_argument("-d", "--dry", action="store_true")
  parser.add_argument("-n", "--name", required=True)
  parser.add_argument("-c", "--cpus", default=cpu_count())
  parser.add_argument("-u", "--uuid", default=str(uuid4()))
  parser.add_argument("-m", "--memory", default=4000)
  parser.add_argument("-s", "--size", default=100)
  parser.add_argument("-i", "--io", default="threads")
  parser.add_argument("-w", "--cache", default="none")
  parser.add_argument("--uefi", action="store_true", default=False)
  parser.add_argument("--lan", required=True)
  parser.add_argument("--bridge", required=True)
  parser.add_argument("--media", required=True)
  parser.add_argument("--drivers", required=True)
  parser.add_argument("--extra", default="")
  return parser.parse_args()


args = parse()


def install(args: Namespace) -> str:
  vmdk = f"{_vmdk_dir_}/{args.name}.img"
  return f"""
    virt-install
    {"--boot uefi" if args.uefi else ""}
    --noautoconsole
    --features kvm_hidden=on
    --virt-type kvm
    --os-variant=win10
    --vcpus {args.cpus},sockets=1
    --cpu host-passthrough
    --memory {args.memory}
    --controller type=scsi,model=virtio-scsi
    --disk path={vmdk},size={args.size},format=raw,sparse=true,bus=scsi,discard=unmap,io={args.io},cache={args.cache}
    --network {args.lan},model=virtio
    --network bridge={args.bridge},model=virtio
    --graphics vnc,listen=0.0.0.0
    --video qxl,ram=256000
    --channel unix,target_type=virtio,name=org.qemu.guest_agent.0
    --disk {args.media},device=cdrom
    --disk {args.drivers},device=cdrom
    --qemu-commandline="-soundhw"
    --qemu-commandline="{_sound_}"
    --qemu-commandline="-uuid"
    --qemu-commandline="{args.uuid}"
    --name {args.name}
    --check disk_size=off
    {args.extra}
    {"--print-xml --dry-run" if args.dry else ""}
    """
